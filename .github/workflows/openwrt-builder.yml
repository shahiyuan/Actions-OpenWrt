name: Build OpenWrt for Askey SBE1V1K (IPQ9574)

on:
  workflow_dispatch:  # 允许手动触发
  # push:
  #   branches: [ main ]  # 可选：推送时自动编译（建议关闭，避免浪费额度）

env:
  REPO_URL: https://github.com/andrewjlamarche/openwrt
  REPO_BRANCH: main
  FEEDS_CONF: feeds.conf.default
  CONFIG_FILE: .config
  DIY_P1_SH: diy-part1.sh
  DIY_P2_SH: diy-part2.sh
  UPLOAD_BIN_DIR: false
  UPLOAD_FIRMWARE: true
  UPLOAD_RELEASE: false
  TZ: Asia/Shanghai  # 可改为你的时区

jobs:
  build:
    runs-on: ubuntu-22.04
    if: github.event.repository.owner.id == github.event.sender.id  # 仅 owner 可触发

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Initialization environment
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          sudo rm -rf /etc/apt/sources.list.d/*
          sudo apt clean
          sudo apt update
          sudo apt install -y \
            ack antlr3 asciidoc autoconf automake autopoint binutils bison build-essential \
            bzip2 ccache cmake cpio curl device-tree-compiler fastjar flex gawk gettext git \
            gperf help2man intltool libelf-dev libglib2.0-dev libncurses5-dev libssl-dev \
            libtool-bin lua5.3 luarocks meson ninja-build patch pkg-config python3 python3-pip \
            python3-ply python3-setuptools rsync subversion swig texinfo uglifyjs unzip wget \
            xmlto xxd zlib1g-dev

      - name: Clone source code
        run: |
          git clone --depth=1 -b ${{ env.REPO_BRANCH }} ${{ env.REPO_URL }} openwrt
          ln -sf ./openwrt .

      - name: Load custom feeds (optional)
        run: |
          [ -e $FEEDS_CONF ] && mv $FEEDS_CONF openwrt/feeds.conf.default

      - name: Load custom configuration
        run: |
          [ -e $CONFIG_FILE ] && cp $CONFIG_FILE openwrt/.config || echo "No custom .config, will generate minimal one"
          cd openwrt
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: Generate minimal .config for SBE1V1K (if no .config provided)
        run: |
          cd openwrt
          if ! grep -q "CONFIG_TARGET_ipq95xx_DEVICE_askey_sbe1v1k=y" .config 2>/dev/null; then
            echo "Generating minimal config for Askey SBE1V1K..."
            make defconfig
            echo "CONFIG_TARGET_ipq95xx=y" >> .config
            echo "CONFIG_TARGET_ipq95xx_DEVICE_askey_sbe1v1k=y" >> .config
            echo "CONFIG_PACKAGE_ipq-wifi-askey-sbe1v1k=y" >> .config
            echo "CONFIG_PACKAGE_kmod-ath12k=y" >> .config
            echo "CONFIG_PACKAGE_kmod-ath12k-core=y" >> .config
            echo "# Enable LuCI web UI (optional)" >> .config
            echo "CONFIG_PACKAGE_luci=y" >> .config
            echo "CONFIG_LUCI_LANG_zh_Hans=y" >> .config
            make defconfig  # normalize
          fi

      - name: Compile firmware
        run: |
          cd openwrt
          echo "Starting build for Askey SBE1V1K..."
          make -j$(nproc) V=s

      - name: Organize firmware directory
        id: organize
        run: |
          cd openwrt/bin/targets/ipq95xx/generic
          ls -l
          mkdir -p firmware
          cp *askey_sbe1v1k* firmware/ 2>/dev/null || echo "No SBE1V1K firmware found!"
          echo "FIRMWARE_PATH=$(pwd)/firmware" >> $GITHUB_ENV

      - name: Upload firmware to Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: openwrt-askey-sbe1v1k-firmware
          path: ${{ env.FIRMWARE_PATH }}
          retention-days: 7
